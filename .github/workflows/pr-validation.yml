---
name: PR Validation

'on':
  pull_request:
    branches:
      - main
      - master
    paths:
      - "custom_components/**"
      - ".github/workflows/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black pylint bandit safety
          # Install component dependencies if requirements file exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Validate manifest.json
        run: |
          echo "Validating component manifest..."
          MANIFEST="custom_components/switch_energy_statistics_estimation/manifest.json"
          python -m json.tool "$MANIFEST" > /dev/null
          echo "✅ Manifest is valid JSON"

      - name: Check version format
        run: |
          MANIFEST="custom_components/switch_energy_statistics_estimation/manifest.json"
          VERSION=$(grep '"version"' "$MANIFEST" | cut -d'"' -f4)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Version format invalid: $VERSION (expected: X.Y.Z)"
            exit 1
          fi
          echo "✅ Version format is valid: $VERSION"

      - name: Check component structure
        run: |
          echo "Checking component file structure..."

          # Required files
          REQUIRED_FILES=(
            "custom_components/switch_energy_statistics_estimation/__init__.py"
            "custom_components/switch_energy_statistics_estimation/manifest.json"
            "custom_components/switch_energy_statistics_estimation/sensor.py"
            "custom_components/switch_energy_statistics_estimation/config_flow.py"
            "custom_components/switch_energy_statistics_estimation/const.py"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file missing: $file"
              exit 1
            else
              echo "✅ Found: $file"
            fi
          done

          echo "✅ Component structure is valid"

      - name: Validate Python syntax
        run: |
          echo "Validating Python syntax..."
          COMPONENT_PATH="custom_components/switch_energy_statistics_estimation"
          python -m py_compile "$COMPONENT_PATH"/*.py
          echo "✅ Python syntax is valid"

      - name: Check Black formatting
        run: |
          echo "Checking code formatting with Black..."
          COMPONENT_PATH="custom_components/switch_energy_statistics_estimation"
          black --check --diff "$COMPONENT_PATH"
          echo "✅ Code formatting is correct"

      - name: Run Pylint
        run: |
          echo "Running Pylint code quality checks..."
          COMPONENT_PATH="custom_components/switch_energy_statistics_estimation"
          # Run pylint with a reasonable score threshold
          pylint "$COMPONENT_PATH" --score=yes --exit-zero || true
          echo "✅ Pylint analysis completed"

      - name: Security scan with Bandit
        run: |
          echo "Running security scan with Bandit..."
          COMPONENT_PATH="custom_components/switch_energy_statistics_estimation"
          bandit -r "$COMPONENT_PATH" -f json -o bandit-report.json || true
          bandit -r "$COMPONENT_PATH" -ll
          echo "✅ Security scan completed"

      - name: Check dependencies for vulnerabilities
        run: |
          echo "Checking dependencies for known vulnerabilities..."
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt || true
          fi
          if [ -f requirements-dev.txt ]; then
            safety check -r requirements-dev.txt || true
          fi
          echo "✅ Dependency security check completed"
